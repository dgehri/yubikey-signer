# Docker Compose for cross-compiling yubikey-signer
#
# Usage:
#   # Build portable x86_64 Linux binaries (signer + proxy)
#   docker compose -f docker/docker-compose.yml run --rm build-x86_64-musl
#
#   # Build aarch64 proxy for routers (direct USB, no pcscd required)
#   docker compose -f docker/docker-compose.yml run --rm build-aarch64-direct-usb
#
# Output:
#   Binaries at: target-docker/<target>/release/

services:
  # Build x86_64-unknown-linux-musl (portable across Linux distros)
  # Produces: yubikey-signer and yubikey-proxy
  # Used in CI and release workflows
  build-x86_64-musl:
    build:
      context: ..
      dockerfile: docker/Dockerfile.x86_64-musl
    volumes:
      - ..:/workspace
      - cargo-cache:/root/.cargo/registry
      - cargo-git:/root/.cargo/git
    working_dir: /workspace

  # Build aarch64 musl with DIRECT USB support (NO pcscd required!)
  # Produces: yubikey-proxy only
  # This is the recommended build for ASUS routers and embedded systems
  # Used in CI and release workflows
  build-aarch64-direct-usb:
    build:
      context: ..
      dockerfile: docker/Dockerfile.aarch64-direct-usb
    volumes:
      - ..:/workspace
      - cargo-cache:/root/.cargo/registry
      - cargo-git:/root/.cargo/git
    working_dir: /workspace

volumes:
  cargo-cache:
  cargo-git:
